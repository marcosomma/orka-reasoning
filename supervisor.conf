[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[program:redis]
command=redis-server /etc/redis/redis.conf
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/redis.log
stderr_logfile=/var/log/supervisor/redis_error.log
priority=10

[program:ollama]
command=ollama serve
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/ollama.log
stderr_logfile=/var/log/supervisor/ollama_error.log
priority=20
environment=OLLAMA_HOST="0.0.0.0:11434",OLLAMA_MODELS="/app/ollama_models"

[program:orka]
command=python3 -m orka.server
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/orka.log
stderr_logfile=/var/log/supervisor/orka_error.log
priority=30
environment=ORKA_MEMORY_BACKEND="redisstack",REDIS_URL="redis://localhost:6380/0",ORKA_PORT="8000",ORKA_LOG_DIR="/logs",PYTHONUNBUFFERED="1"

[eventlistener:shutdown]
command=bash -c "while read line; do echo $line; if echo $line | grep -q 'PROCESS_STATE_FATAL'; then supervisorctl shutdown; fi; done < /dev/stdin"
events=PROCESS_STATE_FATAL

