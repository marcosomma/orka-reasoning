# Migrating to OrKa V0.7.x

This guide helps you upgrade from OrKa V0.6.x to V0.7.x, which introduces RedisStack with HNSW indexing for 100x faster vector search.

## Table of Contents

1. [Breaking Changes](#breaking-changes)
2. [New Features](#new-features)
3. [Migration Steps](#migration-steps)
4. [Configuration Updates](#configuration-updates)
5. [Code Changes](#code-changes)
6. [Troubleshooting](#troubleshooting)

## Breaking Changes

### Memory Backend

- RedisStack is now the default memory backend
- Basic Redis mode requires explicit opt-in
- Vector search API has minor signature changes
- Memory decay configuration structure updated

### Configuration

- YAML schema changes for memory configuration
- Environment variable naming updates
- New required configuration for HNSW

### API Changes

- Memory logger interface updates
- Vector search parameter changes
- New metadata requirements

## New Features

### RedisStack Integration

- 100x faster vector search with HNSW
- Automatic index optimization
- Reduced memory usage
- Higher concurrent operations

### Memory Management

- Improved decay rules
- Better importance scoring
- Enhanced metadata handling
- Namespace isolation

### Performance

- Sub-millisecond vector search
- 60% reduced memory usage
- 1000+ concurrent searches
- Automatic garbage collection

## Migration Steps

### 1. Backup Existing Data

```bash
# Export current memories
orka memory export all --output backup.json

# Save Redis dump
redis-cli SAVE
cp dump.rdb backup.rdb
```

### 2. Install Dependencies

```bash
# Update OrKa
pip install --upgrade orka-reasoning

# Install RedisStack
docker pull redis/redis-stack:latest
docker run -d -p 6379:6379 redis/redis-stack:latest
```

### 3. Update Configuration

Update your YAML files:

```yaml
# Before (V0.6.x)
memory_config:
  backend: redis
  redis_url: redis://localhost:6379/0
  vector_search:
    enabled: true
    index_type: flat

# After (V0.7.x)
memory_config:
  backend: redisstack  # Now default
  redis_url: redis://localhost:6379/0
  enable_hnsw: true   # Enable HNSW indexing
  vector_params:
    M: 16             # HNSW max connections
    ef_construction: 200
    ef_runtime: 10
```

### 4. Migrate Data

```bash
# Run migration script
python scripts/migrate_to_redisstack.py --input backup.json

# Verify migration
orka memory stats
```

### 5. Update Code

Update custom code:

```python
# Before (V0.6.x)
results = memory.search(
    namespace="knowledge",
    query="search text",
    vector=True
)

# After (V0.7.x)
results = memory.search(
    namespace="knowledge",
    query="search text",
    vector=True,
    vector_params={
        "ef_runtime": 10,
        "similarity_threshold": 0.8
    }
)
```

## Configuration Updates

### Environment Variables

New variables:
```bash
# RedisStack configuration
export ORKA_MEMORY_BACKEND=redisstack  # Now default
export ORKA_HNSW_M=16
export ORKA_HNSW_EF_CONSTRUCTION=200
export ORKA_HNSW_EF_RUNTIME=10

# Memory management
export ORKA_MEMORY_DECAY_ENABLED=true
export ORKA_MEMORY_DECAY_SHORT_TERM_HOURS=2
export ORKA_MEMORY_DECAY_LONG_TERM_HOURS=168
```

### YAML Updates

Memory configuration changes:
```yaml
memory_config:
  # New RedisStack options
  enable_hnsw: true
  vector_params:
    M: 16
    ef_construction: 200
    ef_runtime: 10
  
  # Updated decay configuration
  decay:
    enabled: true
    default_short_term_hours: 2
    default_long_term_hours: 168
    importance_rules:
      user_correction: 3.0
      positive_feedback: 2.0
```

## Code Changes

### Memory Operations

```python
# V0.7.x memory operations
from orka.memory import RedisStackMemoryLogger

# Initialize with HNSW
memory = RedisStackMemoryLogger(
    redis_url="redis://localhost:6379/0",
    enable_hnsw=True,
    vector_params={
        "M": 16,
        "ef_construction": 200,
        "ef_runtime": 10
    }
)

# Write with vector
memory_id = memory.write(
    namespace="knowledge",
    content="Information to store",
    vector=True,
    metadata={
        "source": "user",
        "confidence": "high"
    }
)

# Search with HNSW
results = memory.search(
    namespace="knowledge",
    query="search query",
    limit=5,
    similarity_threshold=0.8,
    vector_params={
        "ef_runtime": 10
    }
)
```

### Agent Configuration

```python
# V0.7.x agent configuration
from orka.agents import MemoryReaderAgent

agent = MemoryReaderAgent(
    namespace="knowledge",
    params={
        "enable_context_search": True,
        "context_weight": 0.4,
        "temporal_weight": 0.3,
        "vector_params": {
            "ef_runtime": 10,
            "similarity_threshold": 0.8
        }
    }
)
```

## Troubleshooting

### Common Issues

1. **"FT.CREATE unknown command"**
   - Cause: Using basic Redis instead of RedisStack
   - Solution: Start RedisStack container

2. **Migration failures**
   - Cause: Incompatible data format
   - Solution: Use migration script with --repair flag

3. **Performance issues**
   - Cause: Suboptimal HNSW parameters
   - Solution: Tune M and ef_runtime values

### Verification Steps

```bash
# Check RedisStack
redis-cli FT._LIST

# Verify HNSW indexes
redis-cli FT.INFO orka:mem:idx

# Monitor performance
orka memory watch
```

### Rollback Procedure

If needed, revert to V0.6.x:

```bash
# 1. Install old version
pip install orka-reasoning==0.6.9

# 2. Restore backup
redis-cli FLUSHALL
cp backup.rdb dump.rdb
redis-cli SHUTDOWN
redis-server

# 3. Update configuration
export ORKA_MEMORY_BACKEND=redis
export ORKA_FORCE_BASIC_REDIS=true
```

## Getting Help

If you encounter issues:

1. Check our [Troubleshooting Guide](../troubleshooting.md)
2. Join our [Discord community](https://discord.gg/orka)
3. Open an issue on [GitHub](https://github.com/marcosomma/orka-reasoning/issues)
4. Contact support: support@orkacore.com