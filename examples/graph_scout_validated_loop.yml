# GraphScout with Boolean Validation Loop
# =========================================
#
# This example demonstrates an advanced workflow where GraphScout's path selection
# is iteratively validated and improved using boolean scoring in a loop.
#
# Flow:
# 1. GraphScout proposes an execution path
# 2. PlanValidatorAgent evaluates it with boolean criteria
# 3. If validation fails, GraphScout adjusts and tries again
# 4. Loop continues until path meets quality threshold (0.85)

orchestrator:
  id: validated-graph-scout
  strategy: sequential
  agents:
    - path_discovery_loop
    - path_executor
    - final_execution

agents:
  # Iterative path discovery with validation
  - id: path_discovery_loop
    type: loop
    max_loops: 5
    score_threshold: 0.85  # Path must score 85% to proceed
    persist_across_runs: true
    
    # Boolean scoring for deterministic validation
    scoring:
      preset: moderate
      custom_weights:
        # Emphasize completeness and coherence for routing
        completeness.has_all_required_steps: 0.20
        coherence.logical_agent_sequence: 0.05
        coherence.proper_data_flow: 0.03
    
    # Track validation feedback across loops
    past_loops_metadata:
      loop_number: "{{ get_loop_number() }}"
      score: "{{ score }}"
      timestamp: "{{ timestamp }}"
      insights: "{{ insights }}"
      improvements: "{{ improvements }}"
      mistakes: "{{ mistakes }}"
    
    internal_workflow:
      orchestrator:
        id: discovery-validation
        strategy: sequential
        agents: [path_proposer, path_validator_moderate]
      
      agents:
        # GraphScout for intelligent path discovery
        - id: path_proposer
          type: graph-scout
          params:
            k_beam: 5
            max_depth: 3
            commit_margin: 0.1
            require_terminal: true
            score_weights:
              llm: 0.5
              heuristics: 0.25
              prior: 0.15
              cost: 0.05
              latency: 0.05
            evaluation_model: "local_llm"
            evaluation_model_name: "gpt-oss:20b"
            llm_evaluation_enabled: true
            fallback_to_heuristics: true
          prompt: |
            Select optimal execution path for: {{ get_input() }}
            
            {% if has_past_loops() %}
            ## Validation Feedback (Loop {{ get_loop_number() }})
            
            {% set last_loop = get_past_loops()[-1] %}
            Previous attempt scored: {{ last_loop.score }} (need 0.85)
            
            **Failed Criteria to Address:**
            {% if "has_all_required_steps" in last_loop.mistakes %}
            - Add missing agents for complete workflow
            {% endif %}
            {% if "includes_fallback_path" in last_loop.mistakes %}
            - Include error handling and fallback paths
            {% endif %}
            {% if "handles_edge_cases" in last_loop.mistakes %}
            - Consider edge cases and alternative scenarios
            {% endif %}
            {% if "validates_inputs" in last_loop.mistakes %}
            - Add input validation step
            {% endif %}
            {% if "logical_agent_sequence" in last_loop.mistakes %}
            - Fix agent ordering and dependencies
            {% endif %}
            {% if "proper_data_flow" in last_loop.mistakes %}
            - Ensure proper data flow between agents
            {% endif %}
            
            **Validation History:**
            {% for past_loop in get_past_loops() %}
            Loop {{ past_loop.loop_number }}: {{ past_loop.score }} - {{ past_loop.improvements }}
            {% endfor %}
            {% endif %}
            
            Select path that addresses all validation criteria.
        
        # Validate the proposed path with boolean scoring
        - id: path_validator_moderate
          type: plan_validator
          llm_model: gpt-oss:20b
          model_url: http://localhost:11434/api/generate
          provider: ollama
          temperature: 0.2
          
          # Boolean scoring configuration
          scoring_preset: moderate
          custom_weights:
            completeness.has_all_required_steps: 0.20
            coherence.logical_agent_sequence: 0.05
            coherence.proper_data_flow: 0.03
        
        # Supporting agents for GraphScout to route to
        - id: search_agent
          type: duckduckgo
          capabilities: [data_retrieval, web_search]
          max_results: 5
        
        - id: analysis_agent
          type: local_llm
          capabilities: [reasoning, analysis]
          model: gpt-oss:20b
          model_url: http://localhost:11434/api/generate
          provider: ollama
          prompt: |
            Analyze the following for: {{ input }}
            
            {% if previous_outputs.search_agent %}
            Search Results: {{ previous_outputs.search_agent.results }}
            {% endif %}
            
            Provide comprehensive analysis.
        
        - id: memory_reader
          type: memory
          namespace: validated_paths
          memory_preset: episodic
          config:
            operation: read
            vector: true
            top_k: 5
          prompt: |
            Retrieve context for: {{ input }}
        
        - id: memory_writer
          type: memory
          namespace: validated_paths
          memory_preset: episodic
          config:
            operation: write
            vector: true
          prompt: |
            Store findings: {{ previous_outputs }}
        
        - id: response_builder
          type: local_llm
          capabilities: [answer_emit, response_generation]
          model: gpt-oss:20b
          model_url: http://localhost:11434/api/generate
          provider: ollama
          prompt: |
            Generate final response for: {{ input }}
            
            Available context: {{ previous_outputs }}

  # Execute the validated path
  - id: path_executor
    type: path_executor
    path_source: path_discovery_loop.response.result.path_proposer.target
    on_agent_failure: continue

  # Report on validation and execution
  - id: final_execution
    type: local_llm
    model: gpt-oss:20b
    model_url: http://localhost:11434/api/generate
    provider: ollama
    temperature: 0.3
    prompt: |
      # Validated Path Execution Plan
      
      {% if previous_outputs.path_discovery_loop %}
      {% set loop_result = previous_outputs.path_discovery_loop.response %}
      
      ## Validation Summary
      - Loops Required: {{ previous_outputs.path_discovery_loop.loops_completed }}
      - Final Score: {{ previous_outputs.path_discovery_loop.final_score | round(3) }}
      - Validation Status: {{ 'APPROVED ✓' if previous_outputs.path_discovery_loop.threshold_met else 'FAILED ✗' }}
      
      ## Approved Execution Path
      {% if loop_result.result.path_proposer %}
      {{ loop_result.result.path_proposer.response }}
      {% endif %}
      
      ## Boolean Validation Breakdown
      {% if loop_result.result.path_validator_moderate %}
      {% set validation = loop_result.result.path_validator_moderate %}
      
      **Overall Assessment:** {{ validation.overall_assessment }}
      **Score:** {{ validation.validation_score | round(3) }}
      
      ### Dimension Scores
      {% if validation.dimension_scores %}
      {% for dimension, data in validation.dimension_scores.items() %}
      - {{ dimension|capitalize }}: {{ data.percentage|round(1) }}% ({{ data.score|round(3) }}/{{ data.max_score|round(3) }})
      {% endfor %}
      {% endif %}
      
      ### Passed Criteria ({{ validation.passed_criteria|length }}/15)
      {% for criterion in validation.passed_criteria[:5] %}
      - ✓ {{ criterion }}
      {% endfor %}
      {% if validation.passed_criteria|length > 5 %}
      ... and {{ validation.passed_criteria|length - 5 }} more
      {% endif %}
      
      {% if validation.failed_criteria %}
      ### Failed Criteria ({{ validation.failed_criteria|length }})
      {% for criterion in validation.failed_criteria %}
      - ✗ {{ criterion }}
      {% endfor %}
      {% endif %}
      {% endif %}
      
      ## Evolution Across Loops
      {% if loop_result.past_loops %}
      {% for past_loop in loop_result.past_loops %}
      **Loop {{ past_loop.loop_number }}**: Score {{ past_loop.score }}
      - Issues: {{ past_loop.mistakes or 'None' }}
      {% endfor %}
      {% endif %}
      
      ## Execution Results
      {% if previous_outputs.path_executor %}
      - Execution Status: {{ previous_outputs.path_executor.status | upper }}
      - Executed Path: {{ previous_outputs.path_executor.executed_path }}
      - Agents Completed: {{ previous_outputs.path_executor.results | length }}
      {% if previous_outputs.path_executor.errors %}
      - Errors: {{ previous_outputs.path_executor.errors }}
      {% endif %}
      
      ### Agent Outcomes:
      {% for agent_id, result in previous_outputs.path_executor.results.items() %}
      - **{{ agent_id }}**: {{ 'SUCCESS ✓' if 'error' not in result else 'FAILED ✗' }}
      {% endfor %}
      {% endif %}
      
      ---
      
      ## Your Task
      Now that we have validated AND executed the path, provide:
      
      1. **Executive Summary**: How the path evolved and improved through {{ previous_outputs.path_discovery_loop.loops_completed }} iterations
      2. **Quality Assessment**: Why this path scored {{ previous_outputs.path_discovery_loop.final_score | round(3) }}
      3. **Execution Analysis**: Review the execution results and agent outcomes
      4. **Key Strengths**: What makes this path robust
      5. **Production Readiness**: Based on validation + execution, is it ready for production?
      6. **Recommendations**: Any final suggestions based on actual execution
      
      {% else %}
      No path discovery results available. Unable to proceed.
      {% endif %}

# ============================================================================
# Usage Examples
# ============================================================================
#
# 1. Run with a simple query:
#    orka run graph_scout_validated_loop.yml "What are the latest AI trends?"
#
# 2. Run with a complex query requiring multiple agents:
#    orka run graph_scout_validated_loop.yml "Research quantum computing advances, 
#    analyze their impact on cryptography, and store key findings for future reference"
#
# 3. Observe the validation loop in action:
#    - Watch how GraphScout's proposals improve across iterations
#    - See which boolean criteria fail and get addressed
#    - Track dimension scores (completeness, efficiency, safety, coherence)
#
# 4. Check trace logs for detailed breakdown:
#    - Each loop shows: score, passed_criteria, failed_criteria
#    - Final validation includes dimension_scores and rationale
#    - Evolution summary shows how path quality improved
#
# 5. Adjust validation strictness:
#    - Change score_threshold (line 25): 0.75 (easier) to 0.90 (harder)
#    - Change preset (line 29): lenient → moderate → strict
#    - Add custom_weights (lines 30-34) to emphasize specific criteria
#
# ============================================================================
# Expected Behavior
# ============================================================================
#
# Loop 1: GraphScout proposes initial path
#   → Validator scores it (often 0.60-0.75 on first try)
#   → Identifies missing: edge cases, fallbacks, timeout protection
#
# Loop 2: GraphScout improves path with explicit error handling
#   → Validator scores higher (0.75-0.85)
#   → May still miss: input validation, specific edge cases
#
# Loop 3: GraphScout adds remaining missing pieces
#   → Validator scores 0.85+ 
#   → APPROVED - loop exits
#
# Execution: PathExecutorNode executes the validated path
#   → Runs each agent in sequence
#   → Accumulates results with full context
#   → Reports execution status and outcomes
#
# Result: A thoroughly validated AND executed path with:
#   ✓ All required steps
#   ✓ Edge case handling
#   ✓ Error handling and fallbacks
#   ✓ Input validation
#   ✓ Timeout protection
#   ✓ Logical sequence
#   ✓ Proper data flow
#   ✓ Actual execution results

