# Simple GraphScout + PlanValidator Workflow
# ============================================
#
# Demonstrates a streamlined validation loop where GraphScout
# selects from a focused set of agents, validated by PlanValidator.

orchestrator:
  id: simple-validated-workflow
  strategy: sequential
  agents:
    - workflow_validation_loop
    - path_executor
    - final_summary

agents:
  # Validation loop for workflow design
  - id: workflow_validation_loop
    type: loop
    max_loops: 3
    score_threshold: 0.82
    persist_across_runs: true
    
    scoring:
      preset: moderate
      custom_weights:
        completeness.has_all_required_steps: 0.20
        efficiency.uses_appropriate_agents: 0.12
    
    past_loops_metadata:
      loop_number: "{{ get_loop_number() }}"
      score: "{{ score }}"
      timestamp: "{{ timestamp }}"
      insights: "{{ insights }}"
      improvements: "{{ improvements }}"
      mistakes: "{{ mistakes }}"
    
    internal_workflow:
      orchestrator:
        id: workflow-design-cycle
        strategy: sequential
        agents: [context_analyzer, graphscout_designer, workflow_validator]
      
      agents:
        # Analyze context to guide GraphScout
        - id: context_analyzer
          type: local_llm
          model: gpt-oss:20b
          model_url: http://localhost:11434/api/generate
          provider: ollama
          temperature: 0.3
          prompt: |
            Analyze the workflow request:
            
            Request: {{ get_input() }}
            
            {% if has_past_loops() %}
            Previous design attempt {{ get_loop_number() - 1 }}:
            {% set last = get_past_loops()[-1] %}
            Score: {{ last.score }}
            Issues: {{ last.mistakes }}
            {% endif %}
            
            Extract:
            1. Core objectives
            2. Key requirements  
            3. Expected deliverables
            4. Complexity level (simple/moderate/complex)
        
        # GraphScout designs the workflow
        - id: graphscout_designer
          type: graph-scout
          params:
            k_beam: 5
            max_depth: 3
            commit_margin: 0.12
            require_terminal: true
            score_weights:
              llm: 0.50
              heuristics: 0.30
              prior: 0.12
              cost: 0.04
              latency: 0.04
            safety_profile: default
            cost_budget_tokens: 1200
            latency_budget_ms: 6000
            max_preview_tokens: 200
            evaluation_model: "local_llm"
            evaluation_model_name: "gpt-oss:20b"
            validation_model: "local_llm"
            validation_model_name: "gpt-oss:20b"
            llm_evaluation_enabled: true
            fallback_to_heuristics: true
          prompt: |
            Design an efficient workflow path.
            
            Request: {{ input }}
            Analysis: {{ previous_outputs.context_analyzer.response }}
            
            {% if has_past_loops() %}
            ## Validation Feedback
            {% set last = get_past_loops()[-1] %}
            Previous score: {{ last.score }} (needs {{ 0.82 }})
            
            {% if "has_all_required_steps" in last.mistakes %}
            → Add missing workflow steps
            {% endif %}
            {% if "uses_appropriate_agents" in last.mistakes %}
            → Select better-suited agents
            {% endif %}
            {% if "handles_edge_cases" in last.mistakes %}
            → Include edge case handling
            {% endif %}
            {% if "includes_fallback_path" in last.mistakes %}
            → Add fallback options
            {% endif %}
            {% endif %}
            
            **Available Workflow Agents:**
            
            - requirements_analyzer: Extract and structure requirements
            - workflow_designer: Design step-by-step process flows
            - implementation_planner: Create actionable implementation plans
            - resource_allocator: Define needed resources and timeline
            - workflow_documenter: Generate workflow documentation (terminal)
            
            **Guidelines:**
            1. Select minimum agents needed for completeness
            2. Ensure logical sequence
            3. Include planning AND documentation
            4. End with workflow_documenter
            
            Propose optimal path.
        
        # Validate the workflow design
        - id: workflow_validator
          type: plan_validator
          llm_model: gpt-oss:20b
          model_url: http://localhost:11434/api/generate
          provider: ollama
          temperature: 0.2
          scoring_preset: moderate
          custom_weights:
            completeness.has_all_required_steps: 0.20
            efficiency.uses_appropriate_agents: 0.12

  # Execute the validated workflow
  - id: path_executor
    type: path_executor
    path_source: workflow_validation_loop.response.result.graphscout_designer.target
    on_agent_failure: continue

  # Final summary
  - id: final_summary
    type: local_llm
    model: gpt-oss:20b
    model_url: http://localhost:11434/api/generate
    provider: ollama
    temperature: 0.3
    prompt: |
      # Workflow Design & Execution Summary
      
      {% if previous_outputs.workflow_validation_loop %}
      {% set loop = previous_outputs.workflow_validation_loop %}
      
      ## Validation Results
      - Iterations: {{ loop.loops_completed }}
      - Final Score: {{ (loop.final_score | default(0)) | round(3) }}
      - Status: {{ 'APPROVED ✓' if loop.threshold_met else 'NEEDS REVISION ✗' }}
      
      ## GraphScout's Workflow
      {% if loop.response.result.graphscout_designer %}
      - Proposed Path: {{ loop.response.result.graphscout_designer.target }}
      - Reasoning: {{ loop.response.result.graphscout_designer.reasoning }}
      {% endif %}
      
      ## Validation Details
      {% if loop.response.result.workflow_validator %}
      {% set val = loop.response.result.workflow_validator %}
      - Score: {{ (val.validation_score | default(0)) | round(3) }}/1.0
      - Passed: {{ val.passed_criteria|length }}/15 criteria
      {% if val.failed_criteria %}
      - Failed: {{ val.failed_criteria|length }} criteria
      {% endif %}
      {% endif %}
      
      ## Execution Results
      {% if previous_outputs.path_executor %}
      - Status: {{ previous_outputs.path_executor.status | upper }}
      - Executed Path: {{ previous_outputs.path_executor.executed_path }}
      - Agents Completed: {{ previous_outputs.path_executor.results | length }}
      {% if previous_outputs.path_executor.errors %}
      - Errors: {{ previous_outputs.path_executor.errors }}
      {% endif %}
      
      ### Agent Outcomes:
      {% for agent_id, result in previous_outputs.path_executor.results.items() %}
      - **{{ agent_id }}**: {{ 'SUCCESS' if 'error' not in result else 'FAILED' }}
      {% endfor %}
      {% endif %}
      
      ---
      
      **Comprehensive Analysis:**
      1. Workflow quality and completeness (validation score: {{ (loop.final_score | default(0)) | round(3) }})
      2. Key design decisions and agent selection
      3. Execution effectiveness and results
      4. Implementation readiness and recommendations
      
      {% else %}
      No workflow data available.
      {% endif %}

  # Supporting agents for GraphScout
  - id: requirements_analyzer
    type: local_llm
    capabilities: [requirements_analysis, extraction]
    model: gpt-oss:20b
    model_url: http://localhost:11434/api/generate
    provider: ollama
    prompt: |
      Analyze requirements for: {{ input }}
      
      Extract:
      1. Core Objectives (3-5 bullet points)
      2. Key Stakeholders
      3. Critical Features
      4. Success Criteria

  - id: workflow_designer
    type: local_llm
    capabilities: [workflow_design, process_modeling]
    model: gpt-oss:20b
    model_url: http://localhost:11434/api/generate
    provider: ollama
    prompt: |
      Design workflow for: {{ input }}
      
      {% if previous_outputs.requirements_analyzer %}
      Requirements: {{ previous_outputs.requirements_analyzer.response }}
      {% endif %}
      
      Design:
      1. Step-by-step process flow
      2. Agent/role responsibilities
      3. Data flow and handoffs
      4. Error handling approach
      5. Success metrics

  - id: implementation_planner
    type: local_llm
    capabilities: [implementation_planning, project_management]
    model: gpt-oss:20b
    model_url: http://localhost:11434/api/generate
    provider: ollama
    prompt: |
      Create implementation plan for: {{ input }}
      
      Workflow: {{ previous_outputs.workflow_designer.response if previous_outputs.workflow_designer else previous_outputs }}
      
      Plan:
      1. Implementation Phases (with timelines)
      2. Required Resources
      3. Risk Mitigation Strategies
      4. Deployment Approach
      5. Monitoring Plan

  - id: resource_allocator
    type: local_llm
    capabilities: [resource_planning, capacity_planning]
    model: gpt-oss:20b
    model_url: http://localhost:11434/api/generate
    provider: ollama
    prompt: |
      Resource allocation for: {{ input }}
      
      Context: {{ previous_outputs }}
      
      Define:
      1. Team Structure (roles, responsibilities)
      2. Technology Resources (tools, platforms)
      3. Time Allocation (effort estimates)
      4. Budget Considerations
      5. Capacity Planning

  - id: workflow_documenter
    type: local_llm
    capabilities: [answer_emit, documentation, reporting]
    model: gpt-oss:20b
    model_url: http://localhost:11434/api/generate
    provider: ollama
    prompt: |
      Document complete workflow for: {{ input }}
      
      All Design Artifacts: {{ previous_outputs }}
      
      Create comprehensive documentation:
      
      # Workflow Documentation
      
      ## Overview
      [Summary of workflow purpose and scope]
      
      ## Process Flow
      [Step-by-step workflow description]
      
      ## Implementation Plan
      [Phases, timeline, resources]
      
      ## Success Metrics
      [How to measure success]
      
      ## Next Steps
      [Immediate actions]

# ============================================================================
# Simple Workflow Design
# ============================================================================
#
# This demonstrates a focused GraphScout + PlanValidator loop with
# 5 specialized agents for workflow design:
#
# - requirements_analyzer: Extract and structure requirements
# - workflow_designer: Design process flows
# - implementation_planner: Create actionable plans
# - resource_allocator: Define resources and timeline
# - workflow_documenter: Generate final documentation
#
# GraphScout selects the optimal subset of agents based on query complexity,
# and PlanValidator ensures the design meets quality standards.
#
# ============================================================================
